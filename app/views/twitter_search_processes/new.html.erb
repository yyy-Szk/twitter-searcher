
<div class="home-wrapper">
  <h1 style="margin: 30px 0 0 30px;"><a href="/twitter_search_processes/new">検索ページ</a></h1>

    <p style="margin-left: 30px"><%= link_to "ログアウト", "/logout", method: :delete %></p>

    <% if @is_authenticated %>
    <div style="margin-top: 50px; margin-left: 90px">
      <h2>ユーザーを検索する</h2>

      <% unless current_user.has_active_process? %>
        <%= form_with(url: twitter_search_processes_path, local: true, class: "search-form") do |f| %>
          <div class="search-form-content">

            <% flash.each do |message_type, message| %>
              <p class=<%= "flash-#{message_type}" %>><%= message %></p>
            <% end %>

            <%= f.text_field :seach_content, { name: "conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を

            <%= f.select :search_type, main_twitter_search_types, {}, { name: "conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, main_twitter_search_types, {}, { name: "conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, main_twitter_search_types, {}, { name: "conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, main_twitter_search_types, {}, { name: "conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, main_twitter_search_types, {}, { name: "conditions[][search_type]", class: "search0-type-field" } %>

            <p>かつ</p>

            <%# <p>（最終的には、ボタンを押したら絞り込み条件を一つ追加できるようにしたい。最大で３個くらいつけられるようにする。）</p>
            <p>（ログイン機能を実装したら、ユーザーを検索している間は検索ができないようにする。）</p> %>

            <%= f.text_field :seach_content, { name: "narrow_down_conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, twitter_search_types_for_narrowing, {}, { name: "narrow_down_conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "narrow_down_conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, twitter_search_types_for_narrowing, {}, { name: "narrow_down_conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "narrow_down_conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, twitter_search_types_for_narrowing, {}, { name: "narrow_down_conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "narrow_down_conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, twitter_search_types_for_narrowing, {}, { name: "narrow_down_conditions[][search_type]", class: "search0-type-field" } %>

            <br>

            <%= f.text_field :seach_content, { name: "narrow_down_conditions[][content]", placeholder: "検索したいユーザーのURLを入力", class: "content-field"  } %>
            を
            <%= f.select :search_type, twitter_search_types_for_narrowing, {}, { name: "narrow_down_conditions[][search_type]", class: "search0-type-field" } %>

            <div>
              <%= f.label :remove_following_user, "フォロー済みのユーザーを表示しない" %>
              <%= f.check_box :remove_following_user, { checked: true }, true, false %>
            </div>

            <%= f.submit "検索" %>
          </div>
        <% end %>
      <% else %>
        <p>検索処理が進行中です</p>

        <% current_user.active_process.each do |process| %>

          <p><%= link_to "詳細ページ", "/results/#{process.id}" %></p>
        <% end %>
      <% end %>
    </div>
    <% else %>
      <% client_id = Rails.application.credentials.twitter.dig(:oauth, :client_id) %>
      <% redirect_uri = CGI.escape(Rails.application.credentials.twitter.dig(:oauth, :callback_url)) %>
      <% scopes = "tweet.read%20users.read%20like.read%20follows.read%20follows.write%20offline.access" %>
      <% auth_url = "https://twitter.com/i/oauth2/authorize?response_type=code&client_id=#{client_id}&redirect_uri=#{redirect_uri}&scope=#{scopes}&state=abc&code_challenge=abc&code_challenge_method=plain" %>
      <p>検索するには、<%= link_to 'Twitter認証', auth_url, method: :get %>をしてください</p>
    <% end %>
</div>
